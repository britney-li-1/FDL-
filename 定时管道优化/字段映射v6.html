<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»åŠ è¡¨ - æœ€ç»ˆäº¤ä»˜ç‰ˆ</title>
    <style>
        /* --- 1. åŸºç¡€é‡ç½® --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: rgba(0,0,0,0.6); 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
            color: #333;
        }

        /* åŸå­ç±» */
        .icon { width: 14px; height: 14px; fill: currentColor; vertical-align: middle; }
        .text-gray { color: #999; }
        .text-blue { color: #1890ff; }
        .bg-blue-light { background-color: #e6f7ff; }
        .bg-green-light { background-color: #f6ffed; }

        /* --- 2. å¼¹çª—å®¹å™¨ (80%) --- */
        .modal-container { 
            width: 80%; 
            height: 80%; 
            background: #fff; 
            border-radius: 4px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.3); 
            display: flex; 
            flex-direction: column; 
            min-width: 1000px;
        }

        /* --- Header & Fixed Elements --- */
        .modal-sub-header-group { flex-shrink: 0; background: #fff; z-index: 10; }
        .modal-header { height: 50px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; font-size: 16px; font-weight: 500; }
        .close-btn { font-size: 20px; color: #999; cursor: pointer; }

        .steps-bar { height: 44px; background: #fafafa; border-bottom: 1px solid #e8e8e8; display: flex; align-items: center; padding: 0 24px; font-size: 14px; }
        .step-item { display: flex; align-items: center; color: #999; margin-right: 20px; }
        .step-item.active { color: #333; font-weight: 500; }
        .step-badge { width: 20px; height: 20px; background: #1890ff; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 8px; }

        .global-actions-bar { height: 44px; background: #fff; display: flex; align-items: center; justify-content: flex-end; padding: 0 24px; border-bottom: 1px solid #f0f0f0; }
        .global-batch-btn { height: 28px; padding: 0 12px; border: 1px solid #d9d9d9; background: #fff; border-radius: 2px; font-size: 13px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        /* --- 3. Body Split --- */
        .modal-body { 
            flex: 1; 
            display: flex;
            overflow: hidden; 
            position: relative; 
        }

        /* Sidebar */
        .sidebar { width: 220px; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; background: #fff; flex-shrink: 0; }
        .sidebar-search { padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .search-input { width: 100%; height: 30px; border: 1px solid #d9d9d9; border-radius: 2px; padding: 0 8px; }
        .tree-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .tree-node { padding: 8px 16px; cursor: pointer; font-size: 13px; border-left: 3px solid transparent; transition: background 0.2s; }
        .tree-node.active { background: #e6f7ff; color: #1890ff; border-left-color: #1890ff; }
        .resizer { width: 5px; cursor: col-resize; position: absolute; left: 220px; top: 0; bottom: 0; z-index: 10; }

        /* --- 4. Right Content (Outer Scroll Container) --- */
        .content-viewport {
            flex: 1; 
            overflow-y: auto; /* å¤–å±‚æ•´ä½“æ»šåŠ¨ */
            background: #fff;
            position: relative;
        }

        .content-padding { padding: 20px 24px 0 24px; }
        .section-title { font-size: 15px; font-weight: bold; margin-bottom: 12px; color: #333; }

        /* --- 5. Table Area Wrapper --- */
        /* è¿™ä¸ªå®¹å™¨åŒ…å«ï¼šHeader + Rows + StickyFooter */
        .table-area-border {
            border: 1px solid #e8e8e8;
            background: #fff;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Fixed Header */
        .sticky-header-container {
            position: sticky; top: 0; z-index: 20; background: #fff;
            border-bottom: 1px solid #e8e8e8;
        }
        .toolbar-inner { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f9f9f9; }
        .split-header { display: flex; gap: 20px; padding: 8px 12px; }
        .header-box { flex: 1; height: 32px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .box-src { background: #e6f7ff; color: #333; }
        .box-tgt { background: #d9f7be; color: #333; }
        
        .target-config-controls { display: flex; align-items: center; flex: 1;}
        .mode-select { height: 24px; padding: 0 4px; border: 1px solid #d9d9d9; border-radius: 2px; font-size: 12px; margin-left: 8px; cursor: pointer; color: #333;}
        .name-input { height: 24px; padding: 0 6px; border: 1px solid #d9d9d9; border-radius: 2px; font-size: 12px; margin-left: 4px; width: 140px;}

        .col-header { display: flex; background: #fafafa; font-size: 12px; color: #666; border-top: 1px solid #e8e8e8;}
        .col-group { flex: 1; display: flex; height: 36px; align-items: center; }
        .col-gap { flex: 0 0 30px; }
        .th-chk { width: 40px; text-align: center; }
        .th-flex { flex: 1; padding-left: 8px; }
        .th-sm { width: 50px; text-align: center; }
        .th-smm { width: 60px; text-align: center; }
        .th-op { width: 90px; text-align: center; }

        /* 
           --- [å…³é”®] Table Rows Area ---
           1. min-height: 420px (çº¦9.5è¡Œ) -> ä¿è¯å°å±ä¸‹æ’‘å¼€å¤–å±‚ï¼Œä¸è¢«å‹ç¼©ã€‚
           2. max-height: calc(80vh - 420px) -> è‡ªé€‚åº”å¤§å±ï¼Œ
              å‡å»å¤´éƒ¨(~200)ã€è¡¨æ ¼å¤´(~130)å’Œåº•éƒ¨Configéœ²å¤´éƒ¨åˆ†(~90)ï¼Œç®—å‡ºå‰©ä½™ç»™è¡¨æ ¼çš„ç©ºé—´ã€‚
           3. padding-bottom: 52px -> éšå½¢å«ç‰‡ï¼Œé«˜åº¦ç•¥å¤§äºæ“ä½œæ (48px)ï¼Œ
              å½“æ»šåŠ¨åˆ°åº•éƒ¨æ—¶ï¼Œæœ€åä¸€è¡Œæ•°æ®ä¼šè¢«æ¨ä¸Šå»ï¼Œæ“ä½œæ è¦†ç›–çš„æ˜¯è¿™ä¸ªå«ç‰‡åŒºåŸŸã€‚
              ä»…åœ¨æ“ä½œæ æ˜¾ç¤ºæ—¶æ·»åŠ ï¼Œé¿å…æœªå‹¾é€‰æ—¶çš„ç©ºç™½ã€‚
        */
        .rows-scroll-area {
            background: #fff;
            overflow-y: auto; 
            max-height: max(420px, calc(80vh - 420px));
        }
        
        /* ä»…åœ¨æ“ä½œæ æ˜¾ç¤ºæ—¶æ·»åŠ éšå½¢å«ç‰‡ */
        .table-area-border:has(.sticky-overlay-bar.show) .rows-scroll-area {
            padding-bottom: 52px; /* éšå½¢å«ç‰‡ï¼šé«˜åº¦ç•¥å¤§äºæ“ä½œæ (48px)ï¼Œç¡®ä¿æœ€åä¸€è¡Œå¯é€‰ä¸­ */
        }

        .table-row { display: flex; height: 44px; border-bottom: 1px solid #e8e8e8; align-items: center; font-size: 13px; transition: background 0.1s; }
        .table-row:last-child { border-bottom: none; }
        .table-row.disabled { background: #fafafa; }
        .table-row.disabled .row-input { background: #f5f5f5; color: #ccc; pointer-events: none; }
        .table-row.disabled .text-gray, .table-row.disabled .icon { opacity: 0.5; }
        .table-row:hover:not(.disabled) { background: #f5f7fa; }
        
        .row-left, .row-right { flex: 1; display: flex; height: 100%; align-items: center; }
        .row-mid { flex: 0 0 30px; display: flex; justify-content: center; align-items: center; color:#ccc;}
        .row-input { height: 24px; width: 92%; border: 1px solid #d9d9d9; border-radius: 2px; padding:0 6px; font-size: 12px; }

        .op-actions { display: flex; align-items: center; justify-content: center; gap: 6px; }
        .icon-btn { cursor: pointer; color: #666; display: flex; padding: 4px; border-radius: 4px; }
        .icon-btn:hover { background: #e6f7ff; color: #1890ff; }
        .icon-btn.del:hover { background: #fff1f0; color: #ff4d4f; }
        .drag-handle { cursor: move; color: #bfbfbf; display: flex; padding: 4px; }
        .drag-handle:hover { color: #666; }

        /* --- [æ ¸å¿ƒ] Sticky Overlay Footer Bar --- */
        .sticky-overlay-bar {
            /* ç²˜æ€§å®šä½ï¼šç›¸å¯¹äº content-viewport æ»šåŠ¨ */
            position: sticky;
            bottom: 0;
            z-index: 30; /* å¿…é¡»é«˜äº row */
            
            height: 48px;
            /* è´Ÿ Marginï¼šè®©å®ƒå‘ä¸Šæµ®åŠ¨ï¼Œä¸å æ®æ–‡æ¡£æµé«˜åº¦ï¼Œå®ç° Overlay æ•ˆæœ */
            margin-top: -48px;
            
            background: rgba(255, 255, 255, 0.96); 
            border-top: 1px solid #e8e8e8;
            backdrop-filter: blur(2px);
            
            display: none; 
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 12px;
            
            animation: slideUp 0.15s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .sticky-overlay-bar.show { display: flex; }

        .bar-left { display: flex; align-items: center; gap: 8px; color: #666; }
        .bar-num { color: #1890ff; font-weight: bold; }
        .bar-clear { cursor: pointer; color: #999; margin-left: 4px; }
        .bar-actions { display: flex; gap: 12px; align-items: center; }
        .link-btn { cursor: pointer; color: #666; transition: 0.2s; padding: 4px 8px; border-radius: 4px; }
        .link-btn:hover { color: #1890ff; background: #f0f5ff; }
        .link-btn.danger:hover { color: #ff4d4f; background: #fff1f0; }
        .divider-v { width: 1px; height: 12px; background: #ddd; }

        /* --- 6. Write Config --- */
        .write-config-section { 
            padding: 24px; 
            padding-bottom: 40px; 
            /* è¿™éƒ¨åˆ†åœ¨å¤§å±ä¸‹ï¼Œæ ‡é¢˜ä¼šå› ä¸ºè¡¨æ ¼ max-height é™åˆ¶è€Œéœ²å‡ºæ¥ */
        }
        .bottom-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #333; }
        .cfg-row { display: flex; margin-bottom: 8px; font-size: 13px; }
        .cfg-label { width: 100px; color: #666; }
        .cfg-val { flex: 1; color: #333; display: flex; gap: 8px; flex-wrap: wrap; }
        .pk-tag { display: inline-block; background: #fff; border: 1px solid #ccc; border-radius: 3px; padding: 0 6px; font-size: 12px; margin-right: 6px; }

        /* Footer */
        .modal-footer { height: 60px; border-top: 1px solid #e8e8e8; background: #fff; display: flex; align-items: center; justify-content: flex-end; padding: 0 24px; flex-shrink: 0; z-index: 50; }
        .btn { height: 32px; padding: 0 16px; border: 1px solid #d9d9d9; background: #fff; border-radius: 2px; margin-left: 12px; cursor: pointer; font-size: 14px; }
        .btn:hover { color: #1890ff; border-color: #1890ff; }
        .btn-p { background: #1890ff; color: #fff; border-color: #1890ff; }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body>

<div class="modal-container">
    <div class="modal-sub-header-group">
        <header class="modal-header"><span>æ·»åŠ è¡¨</span><span class="close-btn">Ã—</span></header>
        <div class="steps-bar">
            <div class="step-item active"><span class="step-badge">1</span> é€‰æ‹©æ¥æºè¡¨</div>
            <div class="step-item active"><span class="step-badge">2</span> å­—æ®µæ˜ å°„ä¸å†™å…¥</div>
        </div>
        <div class="global-actions-bar"><div class="global-batch-btn">å…¨éƒ¨è¡¨æ‰¹é‡æ“ä½œ â–¼</div></div>
    </div>

    <div class="modal-body">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-search"><input class="search-input" placeholder="æœç´¢è¡¨"></div>
            <div class="tree-list">
                <div class="tree-node active" data-type="large">ğŸ“… å…¨é‡è¡¨ (50æ¡)</div>
                <div class="tree-node" data-type="mid">ğŸ“… ç¤ºä¾‹è¡¨ (12æ¡)</div>
                <div class="tree-node" data-type="small">ğŸ“… å­—å…¸è¡¨ (4æ¡)</div>
            </div>
        </div>
        <div class="resizer" id="resizer"></div>

        <div class="content-viewport">
            <div class="content-padding">
                <div class="section-title">å­—æ®µæ˜ å°„</div>
                
                <div class="table-area-border">
                    <div class="sticky-header-container">
                        <div class="toolbar-inner">
                            <select style="height:28px; border:1px solid #d9d9d9;"><option>åŒåæ˜ å°„</option></select>
                            <div style="font-size:12px; color:#666; cursor:pointer;">+ æ‰‹åŠ¨å»ºè¡¨ &nbsp; â†» é‡æ–°è·å–</div>
                        </div>
                        <div class="split-header">
                            <div class="header-box box-src">æ¥æº: <span id="lblSource">å…¨é‡è¡¨</span></div>
                            <div class="header-box box-tgt">
                                <div class="target-config-controls">
                                    <span>ç›®æ ‡</span>
                                    <select id="tgtModeSelect" class="mode-select">
                                        <option value="auto">è‡ªåŠ¨å»ºè¡¨</option>
                                        <option value="exist">å·²å­˜åœ¨è¡¨</option>
                                    </select>
                                    <div id="tgtInputContainer" style="display:inline-block;">
                                        <input type="text" class="name-input" value="ç›®æ ‡è¡¨Tabe1">
                                    </div>
                                </div>
                                <span class="icon text-gray">â˜°</span>
                            </div>
                        </div>
                        <div class="col-header">
                            <div class="col-group" style="background:#f0f7ff; border-right:1px solid #fff;">
                                <div class="th-chk"><input type="checkbox" id="checkAll"></div>
                                <div class="th-flex">æ¥æºè¡¨å­—æ®µ</div>
                                <div class="th-flex">ç±»å‹</div>
                                <div class="th-sm">ä¸»é”®</div>
                                <div class="th-smm">Not Null</div>
                            </div>
                            <div class="col-gap"></div>
                            <div class="col-group" style="background:#f6ffed;">
                                <div class="th-flex">ç›®æ ‡è¡¨å­—æ®µ</div>
                                <div class="th-flex">ç±»å‹</div>
                                <div class="th-sm">ç‰©ç†ä¸»é”®</div>
                                <div class="th-smm">NotNull</div>
                                <div class="th-comment">æ³¨é‡Š</div>
                                <div class="th-op">æ“ä½œ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Scrollable Area -->
                    <div class="rows-scroll-area" id="rowContainer">
                        <!-- JS Rows injected here -->
                    </div>
                    
                    <!-- 
                        Sticky Overlay Bar 
                        æ”¾åœ¨ rows-scroll-area å¤–éƒ¨ï¼Œä½†åœ¨ table-area-border å†…éƒ¨çš„æœ€åº•éƒ¨ã€‚
                        å› ä¸º sticky æ˜¯ç›¸å¯¹äºçˆ¶å…ƒç´ æ»šåŠ¨çš„ (content-viewport)ã€‚
                        é…åˆ margin-top: -48px å®ç°è¦†ç›–ã€‚
                    -->
                    <div class="sticky-overlay-bar" id="stickyBar">
                        <div class="bar-left">
                            <span>å·²é€‰ <span class="bar-num" id="selCount">0</span> é¡¹</span>
                            <span class="bar-clear" id="uncheckBtn">æ¸…ç©º</span>
                        </div>
                        <div class="bar-actions">
                            <div class="link-btn">æ¢å¤æ˜ å°„</div>
                            <div class="link-btn">ä¿®æ”¹ç±»å‹</div>
                            <div class="divider-v"></div>
                            <div class="link-btn danger">å–æ¶ˆæ˜ å°„</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="write-config-section">
                <!-- 
                   åœ¨ max-height é™åˆ¶ä¸‹ï¼Œè¿™ä¸ªæ ‡é¢˜ä¼šæ­£å¥½éœ²å‡ºæ¥ 
                -->
                <div class="bottom-title">å†™å…¥æ–¹å¼</div>
                <div class="cfg-row"><span class="cfg-label">å†™å…¥æ–¹å¼</span><span class="cfg-val">ç›´æ¥å°†æ•°æ®å†™å…¥ç›®æ ‡è¡¨</span></div>
                <div class="cfg-row"><span class="cfg-label">ä¸»é”®æ˜ å°„</span><span class="cfg-val" id="pkContainer"></span></div>
            </div>
        </div>
    </div>

    <footer class="modal-footer">
        <button class="btn">å–æ¶ˆ</button>
        <button class="btn btn-p">ç¡®å®š</button>
    </footer>
</div>

<script>
    // --- Data Source ---
    const generateData = (count, namePrefix) => {
        return Array.from({length: count}, (_, i) => ({
            id: i,
            name: `${namePrefix}_å­—æ®µ_${i+1}`,
            type: i % 2 === 0 ? 'varchar' : 'int',
            key: i < 2,
            notNull: i < 5,
            targetName: `${namePrefix}_T_${i+1}`,
            targetType: i % 2 === 0 ? 'varchar' : 'int',
            disabled: false
        }));
    };

    const datasets = {
        'large': generateData(50, 'Large'),
        'mid': generateData(12, 'Mid'),
        'small': generateData(4, 'Small')
    };

    let currentData = datasets['large'];
    const rowContainer = document.getElementById('rowContainer');

    // Icons
    const icons = {
        key: `<svg class="icon text-orange" viewBox="0 0 1024 1024"><path d="M780 160c-110.5 0-200 89.5-200 200 0 34.3 8.7 66.5 24.1 94.7L254.6 804.2 210 760l-36 36 80 80 34 34 76-78 36-36-44.6-44.6 349.5-349.5c28.2 15.4 60.4 24.1 94.7 24.1 110.5 0 200-89.5 200-200s-89.5-200-200-200zm0 280c-44.2 0-80-35.8-80-80s35.8-80 80-80 80 35.8 80 80-35.8 80-80 80z"/></svg>`,
        del: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm165.4 618.2l-66-.3L512 563.4l-99.3 118.4-66.1.3c-4.4 0-8.1-2.8-9.3-7.1-1.2-4.3.5-8.9 4.1-11.5l133.4-159-132.5-159.2c-3.6-2.6-5.3-7.2-4.1-11.5 1.2-4.3 4.9-7.1 9.3-7.1l66 .3L512 445.6l99.3-118.4 66-.3c4.4 0 8.1 2.8 9.3 7.1 1.2 4.3-.5 8.9-4.1 11.5L549.2 504.6l132.5 159.2c3.6 2.6 5.3 7.2 4.1 11.5-1.2 4.3-4.9 7.1-9.4 7.1z"/></svg>`,
        restore: `<svg class="icon text-blue" viewBox="0 0 1024 1024"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/><path d="M719.4 499.1l-157.6-1.4c-5.1 0-9.6 3.6-10.6 8.6l-28.7 143.5c-1.3 6.6 7.2 10.7 11.4 5.5l37.2-46.1c32.7 26.6 54.3 67.2 54.3 113 0 80.5-65.7 146-146.5 146-80.9 0-146.5-65.5-146.5-146 0-37.4 14.1-71.6 37.3-97.7 2.8 3.1 7.1 3.5 10.4 1l40.7-30.8c2.9-2.2 4-6.1 2.6-9.4-33.1 36.6-53.3 85-53.3 137 0 114.7 93.3 207.8 208.2 207.8S787 737 787 622.2c0-62.7-27.9-118.8-72.2-157l37-45.7c4.2-5.1-0.2-13.3-6.8-13.3z"/></svg>`,
        drag: `<svg class="icon" viewBox="0 0 1024 1024" style="width:16px; height:16px;"><path d="M341.333 256a42.667 42.667 0 1 1 0-85.333 42.667 42.667 0 0 1 0 85.333z m341.334 0a42.667 42.667 0 1 1 0-85.333 42.667 42.667 0 0 1 0 85.333z m-341.334 341.333a42.667 42.667 0 1 1 0-85.333 42.667 42.667 0 0 1 0 85.333z m341.334 0a42.667 42.667 0 1 1 0-85.333 42.667 42.667 0 0 1 0 85.333z m-341.334 341.334a42.667 42.667 0 1 1 0-85.334 42.667 42.667 0 0 1 0 85.334z m341.334 0a42.667 42.667 0 1 1 0-85.334 42.667 42.667 0 0 1 0 85.334z" fill="#bfbfbf" /></svg>`
    };

    function render(type) {
        currentData = datasets[type];
        
        // Update Source Label
        document.getElementById('lblSource').innerText = type === 'large' ? 'å…¨é‡è¡¨' : (type === 'mid' ? 'ç¤ºä¾‹è¡¨' : 'å­—å…¸è¡¨');
        
        let html = '';
        currentData.forEach(f => {
            const rowClass = f.disabled ? 'table-row disabled' : 'table-row';
            const actionBtn = f.disabled 
                ? `<span class="icon-btn" onclick="toggleMap(${f.id})" title="æ¢å¤">${icons.restore}</span>`
                : `<span class="icon-btn del" onclick="toggleMap(${f.id})" title="å–æ¶ˆ">${icons.del}</span>`;

            html += `
            <div class="${rowClass}" draggable="true">
                <div class="row-left">
                    <div class="th-chk"><input type="checkbox" class="row-chk"></div>
                    <div class="th-flex">${f.name}</div>
                    <div class="th-flex text-gray">${f.type}</div>
                    <div class="th-sm">${f.key ? icons.key : ''}</div>
                    <div class="th-smm"><input type="checkbox" disabled ${f.notNull?'checked':''}></div>
                </div>
                <div class="row-mid">âœ</div>
                <div class="row-right">
                    <div class="th-flex"><input class="row-input" value="${f.targetName}"></div>
                    <div class="th-flex"><input class="row-input" value="${f.targetType}"></div>
                    <div class="th-sm"></div>
                    <div class="th-smm"><input type="checkbox" ${f.notNull?'checked':''}></div>
                    <div class="th-comment text-gray" style="font-size:12px;">--</div>
                    <div class="th-op op-actions">
                        ${actionBtn}
                        <span class="drag-handle" title="æ•´è¡Œæ‹–æ‹½">${icons.drag}</span>
                    </div>
                </div>
            </div>`;
        });
        
        rowContainer.innerHTML = html;
        document.getElementById('pkContainer').innerHTML = currentData.filter(f=>f.key).map(f=>`<span class="pk-tag">${f.name}=${f.name}</span>`).join('');
        
        bindEvents();
    }

    // Toggle logic
    window.toggleMap = function(id) {
        const item = currentData.find(f => f.id === id);
        if(item) {
            item.disabled = !item.disabled;
            const activeType = document.querySelector('.tree-node.active').dataset.type;
            render(activeType);
        }
    }

    // Target Table Logic
    const tgtMode = document.getElementById('tgtModeSelect');
    const inputWrap = document.getElementById('tgtInputContainer');
    tgtMode.addEventListener('change', e => {
        if(e.target.value === 'auto'){
            inputWrap.innerHTML = '<input type="text" class="name-input" value="ç›®æ ‡è¡¨Tabe1">';
        } else {
            inputWrap.innerHTML = `
                <select class="name-input" style="height:24px;">
                    <option>Existing_Tbl_01</option>
                    <option>Existing_Tbl_02</option>
                </select>`;
        }
    });

    function bindEvents() {
        document.getElementById('stickyBar').classList.remove('show');
        const checkAll = document.getElementById('checkAll');
        if(checkAll) { checkAll.checked = false; checkAll.indeterminate = false; }

        const checks = document.querySelectorAll('.row-chk');
        const bar = document.getElementById('stickyBar');
        const countSpan = document.getElementById('selCount');
        const clearBtn = document.getElementById('uncheckBtn');

        const update = () => {
            const n = Array.from(checks).filter(c=>c.checked).length;
            if (n > 0) {
                bar.classList.add('show');
                countSpan.innerText = n;
            } else {
                bar.classList.remove('show');
            }
            if(checkAll) {
                checkAll.checked = (n === currentData.length && n > 0);
                checkAll.indeterminate = (n > 0 && n < currentData.length);
            }
        }

        checks.forEach(c => c.addEventListener('change', update));
        
        const oldCheckAll = document.getElementById('checkAll');
        const newCheckAll = oldCheckAll.cloneNode(true);
        oldCheckAll.parentNode.replaceChild(newCheckAll, oldCheckAll);
        
        newCheckAll.addEventListener('change', e => {
            const currentChecks = document.querySelectorAll('.row-chk');
            currentChecks.forEach(c => c.checked = e.target.checked);
            update();
        });

        const oldClear = document.getElementById('uncheckBtn');
        const newClear = oldClear.cloneNode(true);
        oldClear.parentNode.replaceChild(newClear, oldClear);
        
        newClear.addEventListener('click', () => {
            const currentChecks = document.querySelectorAll('.row-chk');
            currentChecks.forEach(c => c.checked = false);
            newCheckAll.checked = false;
            bar.classList.remove('show');
        });
    }

    // Sidebar
    const treeNodes = document.querySelectorAll('.tree-node');
    treeNodes.forEach(n => {
        n.addEventListener('click', () => {
            treeNodes.forEach(node => node.classList.remove('active'));
            n.classList.add('active');
            render(n.dataset.type);
        });
    });

    // Resizer
    const resizer = document.getElementById('resizer');
    const sidebar = document.getElementById('sidebar');
    let r = false;
    resizer.addEventListener('mousedown', () => {r=true; document.body.style.cursor='col-resize'});
    document.addEventListener('mousemove', e => { if(r){ 
        const w = e.clientX - sidebar.parentElement.getBoundingClientRect().left;
        if(w>150 && w<600) sidebar.style.width=w+'px';
    }});
    document.addEventListener('mouseup', () => {r=false; document.body.style.cursor='default'});

    // Init with Large data
    render('large');

</script>
</body>
</html>