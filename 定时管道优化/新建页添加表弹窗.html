<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加表弹窗（无步骤条版）</title>
    <!-- 引入 FontAwesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 基础变量与样式重置 --- */
        :root {
            --primary-blue: #3c78f8;
            --primary-blue-hover: #2960d7;
            --text-main: #303133;
            --text-regular: #606266;
            --text-secondary: #909399;
            --border-color: #ebeef5;
            --bg-body: #f5f7fa;
            --hover-bg: #f5f7fa;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 模拟触发按钮 */
        .trigger-btn {
            padding: 10px 20px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        /* --- 添加表弹窗样式 --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-dialog {
            background: #fff;
            border-radius: 4px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        /* 原有的 .modal-steps 样式已删除 */

        .modal-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 500px;
        }

        .modal-left-panel {
            width: 400px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .modal-right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .panel-title {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-color);
        }

        .panel-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .panel-search input {
            width: 100%;
            padding: 6px 30px 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }

        .panel-search .search-icon {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        /* 树形列表样式 */
        .table-tree {
            list-style: none;
        }

        .tree-category {
            margin-bottom: 8px;
        }

        .tree-category-header {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-main);
            user-select: none;
        }

        .tree-category-header:hover {
            background: #f0f0f0;
        }

        .tree-category-icon {
            width: 16px;
            margin-right: 6px;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .tree-category-children {
            margin-left: 22px;
            display: none;
        }

        .tree-category.expanded .tree-category-children {
            display: block;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-regular);
            border-radius: 2px;
        }

        .tree-item:hover {
            background: #f0f0f0;
        }

        .tree-checkbox {
            width: 14px;
            height: 14px;
            border: 1px solid #dcdfe6;
            border-radius: 2px;
            margin-right: 8px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            background: #fff;
        }

        .tree-checkbox.checked {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .tree-checkbox.checked::after {
            content: '\2713';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
        }

        .tree-item-name {
            flex: 1;
        }

        .tree-item-badge {
            font-size: 11px;
            color: var(--text-secondary);
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 2px;
            margin-left: 8px;
        }

        /* 右侧已选区域及批量操作 */
        .selected-table-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .batch-action-bar {
            display: none;
            padding: 12px 16px;
            background: #ecf5ff;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .batch-action-bar.show {
            display: flex;
        }

        .batch-selection-info {
            color: var(--primary-blue);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .batch-close {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 16px;
            padding: 2px 4px;
        }

        .batch-divider {
            width: 1px;
            height: 16px;
            background: #dcdfe6;
        }

        .batch-actions {
            display: flex;
            gap: 16px;
            margin-left: auto;
        }

        .batch-action-btn {
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 13px;
            padding: 4px 0;
            position: relative;
        }

        .batch-action-btn:hover {
            text-decoration: underline;
        }

        .batch-action-btn.disabled {
            color: #c0c4cc;
            cursor: not-allowed;
            text-decoration: none;
        }

        .table-wrapper {
            flex: 1;
            overflow-y: auto;
        }

        .selected-table-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .selected-table-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .selected-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .selected-table thead {
            background: #f5f7fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .selected-table th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-regular);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .selected-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .selected-table tbody tr:hover {
            background: var(--hover-bg);
        }

        /* 选中表中的分类行 */
        .category-row {
            background: #fff;
        }
        .category-row .category-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-main);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }
        .category-row .category-label .expand-icon {
            font-size: 10px;
            color: var(--text-regular);
            transition: transform 0.2s;
        }
        .category-row.expanded .category-label .expand-icon {
            transform: rotate(90deg);
        }

        /* 子表样式 */
        .selected-row.sub-row {
            background: #fafafa;
        }
        .sub-indicator-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 50%;
            width: 1px;
            background: #dcdfe6;
        }
        .sub-indicator-line::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 15px;
            height: 1px;
            background: #dcdfe6;
        }

        .sub-table-toggle {
            color: var(--primary-blue);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .sub-table-toggle:hover {
            text-decoration: underline;
        }

        .sync-start-input {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        .sync-start-input input {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            width: 160px;
        }

        .delete-btn {
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
        }
        .delete-btn:hover {
            color: #f56c6c;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #fff;
        }

        .btn-cancel {
            background: #fff;
            border: 1px solid #dcdfe6;
            color: var(--text-regular);
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            color: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .btn-confirm {
            background: var(--primary-blue);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-confirm:hover {
            background: var(--primary-blue-hover);
        }
    </style>
</head>
<body>

    <!-- 触发按钮 -->
    <button class="trigger-btn" id="btnAddTable">
        <i class="fa-solid fa-circle-plus"></i> 点击打开“添加表”弹窗
    </button>

    <!-- 添加表弹窗 START -->
    <div class="modal-overlay" id="addTableModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <div class="modal-title">添加表</div>
                <button class="modal-close" id="closeModal">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <!-- 步骤条已移除 -->
            <div class="modal-body">
                <!-- 左侧：选择表 -->
                <div class="modal-left-panel">
                    <div class="panel-title">选择表</div>
                    <div class="panel-search">
                        <input type="text" placeholder="搜索库/表" id="tableSearch">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    </div>
                    <div class="panel-content">
                        <ul class="table-tree" id="tableTree">
                            <!-- 基础类 -->
                            <li class="tree-category expanded">
                                <div class="tree-category-header">
                                    <i class="fa-solid fa-caret-down tree-category-icon"></i>
                                    <span>基础类</span>
                                </div>
                                <ul class="tree-category-children">
                                    <li class="tree-item" data-table="仓库查询" data-type="全量表" data-category="基础类">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">仓库查询</span>
                                        <span class="tree-item-badge">全量表</span>
                                    </li>
                                    <li class="tree-item" data-table="店铺查询" data-type="全量表" data-category="基础类">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">店铺查询</span>
                                        <span class="tree-item-badge">全量表</span>
                                    </li>
                                    <li class="tree-item" data-table="供应商查询" data-type="增量表" data-category="基础类" data-has-sub="false">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">供应商查询</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                    <li class="tree-item" data-table="分销商查询" data-type="增量表" data-category="基础类">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">分销商查询</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                    <li class="tree-item" data-table="入库单查询" data-type="增量表" data-category="基础类" data-has-sub="true" data-sub-name="入库单查询-明细">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">入库单查询</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                    <li class="tree-item" data-table="货品价目表" data-type="增量表" data-category="基础类" data-has-sub="false">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">货品价目表</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                </ul>
                            </li>
                            <!-- 入库类 -->
                            <li class="tree-category">
                                <div class="tree-category-header">
                                    <i class="fa-solid fa-caret-right tree-category-icon"></i>
                                    <span>入库类</span>
                                </div>
                                <ul class="tree-category-children">
                                    <li class="tree-item" data-table="采购入库" data-type="增量表" data-category="入库类">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">采购入库</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                    <li class="tree-item" data-table="退货入库" data-type="增量表" data-category="入库类">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">退货入库</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                    <li class="tree-item" data-table="物流入库" data-type="增量表" data-category="入库类">
                                        <div class="tree-checkbox"></div>
                                        <span class="tree-item-name">物流入库</span>
                                        <span class="tree-item-badge">增量表</span>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 右侧：处理表 -->
                <div class="modal-right-panel">
                    <div class="panel-title">处理表</div>
                    <!-- 批量操作栏 -->
                    <div class="batch-action-bar" id="batchActionBar">
                        <div class="batch-selection-info">
                            <span>已选择 <span id="selectedCount">0</span>/<span id="totalCount">0</span></span>
                            <i class="fa-solid fa-xmark batch-close" id="batchClose"></i>
                        </div>
                        <div class="batch-divider"></div>
                        <div class="batch-actions">
                            <span class="batch-action-btn" id="batchSyncStart">
                                首次同步起点
                            </span>
                            <span class="batch-action-btn" id="batchSubTable">
                                子表处理
                            </span>
                            <span class="batch-action-btn" id="batchDelete">批量删除</span>
                        </div>
                    </div>
                    <div class="selected-table-container" id="selectedTableContainer">
                        <!-- 空状态 -->
                        <div class="selected-table-empty" id="emptyState">
                            <i class="fa-solid fa-inbox"></i>
                            <div>暂无已选表，请在左侧勾选表</div>
                        </div>
                        <!-- 已选表列表 -->
                        <div class="table-wrapper" id="tableWrapper" style="display: none;">
                            <table class="selected-table" id="selectedTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <div class="tree-checkbox" id="selectAllCheckbox"></div>
                                        </th>
                                        <th style="min-width: 200px;">来源表</th>
                                        <th style="min-width: 100px;">表类型 <i class="fa-solid fa-filter" style="font-size:10px; color:#909399;"></i></th>
                                        <th style="min-width: 200px;">同步起点</th>
                                        <th style="min-width: 150px;">子表处理</th>
                                        <th style="width: 60px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="selectedTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="btnCancel">取消</button>
                <button class="btn-confirm" id="btnConfirm">确定</button>
            </div>
        </div>
    </div>
    <!-- 添加表弹窗 END -->

    <script>
        // ========== 添加表弹窗逻辑 ==========
        const modal = document.getElementById('addTableModal');
        const btnAddTable = document.getElementById('btnAddTable');
        const closeModal = document.getElementById('closeModal');
        const btnCancel = document.getElementById('btnCancel');
        const btnConfirm = document.getElementById('btnConfirm');
        const selectedTableContainer = document.getElementById('selectedTableContainer');
        const emptyState = document.getElementById('emptyState');
        const tableWrapper = document.getElementById('tableWrapper');
        const selectedTableBody = document.getElementById('selectedTableBody');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const batchActionBar = document.getElementById('batchActionBar');
        const selectedCount = document.getElementById('selectedCount');
        const totalCount = document.getElementById('totalCount');
        const batchClose = document.getElementById('batchClose');
        const batchSyncStart = document.getElementById('batchSyncStart');
        const batchSubTable = document.getElementById('batchSubTable');
        const batchDelete = document.getElementById('batchDelete');

        // 存储已选表的数据
        let selectedTables = {};
        // 存储批量选中的表（用于右侧批量操作）
        let batchSelectedTables = new Set();

        // 打开弹窗
        btnAddTable.addEventListener('click', () => {
            modal.classList.add('show');
        });

        // 清空弹窗数据
        function clearModalData() {
            // 清空已选表数据
            selectedTables = {};
            batchSelectedTables.clear();
            
            // 清空左侧所有勾选状态
            document.querySelectorAll('.tree-item .tree-checkbox').forEach(checkbox => {
                checkbox.classList.remove('checked');
            });
            
            // 重置右侧显示状态
            emptyState.style.display = 'flex';
            tableWrapper.style.display = 'none';
            batchActionBar.classList.remove('show');
            selectAllCheckbox.classList.remove('checked');
            selectedTableBody.innerHTML = '';
            
            // 清空搜索框
            const tableSearch = document.getElementById('tableSearch');
            if (tableSearch) {
                tableSearch.value = '';
                // 恢复所有表项的显示
                document.querySelectorAll('.tree-item').forEach(item => {
                    item.style.display = 'flex';
                });
            }
        }

        // 关闭弹窗
        function closeModalFunc() {
            clearModalData();
            modal.classList.remove('show');
        }

        // 确定操作
        function confirmModalFunc() {
            const tableCount = Object.keys(selectedTables).length;
            if (tableCount === 0) {
                alert('请至少选择一张表');
                return;
            }
            alert(`已确认添加 ${tableCount} 张表！\n（此处为演示，实际应提交数据）`);
            closeModalFunc();
        }

        closeModal.addEventListener('click', closeModalFunc);
        btnCancel.addEventListener('click', closeModalFunc);
        btnConfirm.addEventListener('click', confirmModalFunc);

        // 点击遮罩层关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModalFunc();
            }
        });

        // 分类展开/折叠
        document.querySelectorAll('.tree-category-header').forEach(header => {
            header.addEventListener('click', function() {
                const category = this.parentElement;
                category.classList.toggle('expanded');
                const icon = this.querySelector('.tree-category-icon');
                if (category.classList.contains('expanded')) {
                    icon.classList.remove('fa-caret-right');
                    icon.classList.add('fa-caret-down');
                } else {
                    icon.classList.remove('fa-caret-down');
                    icon.classList.add('fa-caret-right');
                }
            });
        });

        // 左侧表项勾选逻辑
        document.querySelectorAll('.tree-item').forEach(item => {
            const checkbox = item.querySelector('.tree-checkbox');
            checkbox.addEventListener('click', function(e) {
                e.stopPropagation();
                const isChecked = this.classList.toggle('checked');
                const tableName = item.dataset.table;
                const tableType = item.dataset.type;
                const category = item.dataset.category;
                const hasSub = item.dataset.hasSub === 'true';
                const subName = item.dataset.subName || tableName;

                if (isChecked) {
                    // 添加到已选表
                    selectedTables[tableName] = {
                        name: tableName,
                        type: tableType,
                        category: category,
                        hasSub: hasSub,
                        subName: subName,
                        subTableMode: hasSub ? 'sub' : null, // 'sub' 表示以子表输出, 'field' 表示以字段输出
                        syncStart: tableType === '全量表' ? '全量表,无需配置' : '2023-05-23 12:23:20'
                    };
                } else {
                    // 从已选表移除
                    delete selectedTables[tableName];
                    // 如果移除的是当前批量选中的表，也要清除选中状态
                    if(batchSelectedTables.has(tableName)){
                        batchSelectedTables.delete(tableName);
                    }
                }
                updateSelectedTableDisplay();
                updateBatchActionBar(); // 确保批量操作栏状态更新
            });
        });

        // 更新批量操作栏状态
        function updateBatchActionBar() {
            const selectedCountNum = batchSelectedTables.size;
            const totalCountNum = Object.keys(selectedTables).length;
            
            if (selectedCountNum > 0) {
                batchActionBar.classList.add('show');
                selectedCount.textContent = selectedCountNum;
                totalCount.textContent = totalCountNum;
                
                // 检查选中表的状态
                let hasIncrementalTable = false;
                let hasSubTable = false;
                
                batchSelectedTables.forEach(tableName => {
                    const table = selectedTables[tableName];
                    if (table) {
                        if (table.type === '增量表') {
                            hasIncrementalTable = true;
                        }
                        if (table.hasSub) {
                            hasSubTable = true;
                        }
                    }
                });
                
                // 更新按钮状态
                if (hasIncrementalTable) {
                    batchSyncStart.classList.remove('disabled');
                } else {
                    batchSyncStart.classList.add('disabled');
                }
                
                if (hasSubTable) {
                    batchSubTable.classList.remove('disabled');
                } else {
                    batchSubTable.classList.add('disabled');
                }
            } else {
                batchActionBar.classList.remove('show');
            }
        }

        // 更新右侧已选表显示
        function updateSelectedTableDisplay() {
            const tableKeys = Object.keys(selectedTables);
            
            if (tableKeys.length === 0) {
                // 显示空状态
                emptyState.style.display = 'flex';
                tableWrapper.style.display = 'none';
                batchActionBar.classList.remove('show');
                selectAllCheckbox.classList.remove('checked');
                batchSelectedTables.clear();
            } else {
                // 显示已选表
                emptyState.style.display = 'none';
                tableWrapper.style.display = 'block';
                
                // 按分类分组
                const groupedTables = {};
                tableKeys.forEach(key => {
                    const table = selectedTables[key];
                    if (!groupedTables[table.category]) {
                        groupedTables[table.category] = [];
                    }
                    groupedTables[table.category].push(table);
                });

                // 生成表格内容 - 分类和表在同一行显示
                let html = '';
                Object.keys(groupedTables).forEach(category => {
                    const categoryId = 'category-' + category.replace(/\s+/g, '-');
                    const tables = groupedTables[category];
                    
                    // 分类行
                    html += `
                        <tr class="category-row expanded" id="${categoryId}" data-category="${category}">
                            <td style="width: 40px;"></td>
                            <td colspan="5" class="category-label">
                                <i class="fa-solid fa-caret-down expand-icon"></i>
                                分类:${category}
                            </td>
                        </tr>
                    `;
                    
                    // 该分类下的表
                    tables.forEach((table) => {
                        const rowId = 'row-' + table.name.replace(/\s+/g, '-');
                        const subTableMode = table.subTableMode || (table.hasSub ? 'sub' : 'field');
                        const isBatchSelected = batchSelectedTables.has(table.name);
                        
                        html += `
                            <tr class="selected-row" id="${rowId}" data-table="${table.name}">
                                <td>
                                    <div class="tree-checkbox row-checkbox ${isBatchSelected ? 'checked' : ''}" data-table="${table.name}"></div>
                                </td>
                                <td>
                                    <i class="fa-solid fa-table" style="color: var(--primary-blue); margin-right: 6px;"></i>
                                    ${table.name}
                                </td>
                                <td>${table.type}</td>
                                <td>
                                    ${table.type === '全量表' 
                                        ? '全量表,无需配置' 
                                        : `<div class="sync-start-input">
                                            <input type="text" value="${table.syncStart}" readonly>
                                            <i class="fa-regular fa-calendar"></i>
                                        </div>`
                                    }
                                </td>
                                <td>
                                    ${table.hasSub 
                                        ? `<span class="sub-table-toggle" data-table="${table.name}">
                                            ${subTableMode === 'sub' ? '以子表输出' : '以字段输出'}
                                            <i class="fa-solid fa-rotate"></i>
                                        </span>`
                                        : '无子表,无需处理'
                                    }
                                </td>
                                <td>
                                    <i class="fa-regular fa-trash-can delete-btn" data-table="${table.name}"></i>
                                </td>
                            </tr>
                        `;
                        
                        // 如果有子表且为子表输出模式，显示子表行
                        if (table.hasSub && subTableMode === 'sub') {
                            html += `
                                <tr class="selected-row sub-row" id="sub-${rowId}">
                                    <td style="position: relative;">
                                        <span class="sub-indicator-line"></span>
                                    </td>
                                    <td style="padding-left: 20px;">
                                        ${table.subName || table.name}
                                    </td>
                                    <td>增量子表</td>
                                    <td>跟随主表</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            `;
                        }
                    });
                });

                selectedTableBody.innerHTML = html;

                // 重新绑定事件
                bindDynamicEvents();
                updateSelectAllCheckbox();
            }
        }

        // 绑定动态生成的 DOM 事件
        function bindDynamicEvents() {
            // 绑定分类展开/折叠
            document.querySelectorAll('.category-label').forEach(label => {
                label.addEventListener('click', function() {
                    const categoryRow = this.closest('.category-row');
                    const isExpanded = categoryRow.classList.toggle('expanded');
                    const category = categoryRow.dataset.category;
                    
                    // 简单的显示/隐藏逻辑
                    let currentRow = categoryRow.nextElementSibling;
                    while (currentRow) {
                        // 遇到下一个分类行则停止
                        if (currentRow.classList.contains('category-row')) break;

                        if (!currentRow.classList.contains('sub-row')) {
                            // 主表行
                            if (isExpanded) {
                                currentRow.style.display = '';
                                // 如果有对应的子表行，也要显示
                                const subRow = document.getElementById('sub-' + currentRow.id);
                                if (subRow) subRow.style.display = '';
                            } else {
                                currentRow.style.display = 'none';
                                // 隐藏对应子表行
                                const subRow = document.getElementById('sub-' + currentRow.id);
                                if (subRow) subRow.style.display = 'none';
                            }
                        }
                        currentRow = currentRow.nextElementSibling;
                    }
                });
            });

            // 绑定子表切换事件
            document.querySelectorAll('.sub-table-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const tableName = this.dataset.table;
                    const table = selectedTables[tableName];
                    if (table) {
                        table.subTableMode = table.subTableMode === 'sub' ? 'field' : 'sub';
                        updateSelectedTableDisplay();
                    }
                });
            });

            // 绑定单个删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tableName = this.dataset.table;
                    delete selectedTables[tableName];
                    batchSelectedTables.delete(tableName);
                    
                    // 同时取消左侧树的勾选状态
                    document.querySelectorAll('.tree-item').forEach(item => {
                        if (item.dataset.table === tableName) {
                            item.querySelector('.tree-checkbox').classList.remove('checked');
                        }
                    });
                    
                    updateSelectedTableDisplay();
                    updateBatchActionBar();
                });
            });

            // 绑定右侧表格复选框点击事件（批量选择）
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tableName = this.dataset.table;
                    const isChecked = this.classList.toggle('checked');
                    
                    if (isChecked) {
                        batchSelectedTables.add(tableName);
                    } else {
                        batchSelectedTables.delete(tableName);
                    }
                    
                    updateBatchActionBar();
                    updateSelectAllCheckbox();
                });
            });
        }
        
        // 更新全选复选框状态
        function updateSelectAllCheckbox() {
            const allRows = selectedTableBody.querySelectorAll('.selected-row:not(.category-row):not(.sub-row)');
            // 注意：要检查 row-checkbox 是否被选中
            const checkedRows = Array.from(allRows).filter(row => row.querySelector('.row-checkbox').classList.contains('checked'));

            if (allRows.length > 0 && allRows.length === checkedRows.length) {
                selectAllCheckbox.classList.add('checked');
            } else {
                selectAllCheckbox.classList.remove('checked');
            }
        }

        // 全选/取消全选
        selectAllCheckbox.addEventListener('click', function() {
            const isChecked = this.classList.toggle('checked');
            const allCheckboxes = selectedTableBody.querySelectorAll('.row-checkbox');
            
            allCheckboxes.forEach(cb => {
                const tableName = cb.dataset.table;
                if (isChecked) {
                    cb.classList.add('checked');
                    batchSelectedTables.add(tableName);
                } else {
                    cb.classList.remove('checked');
                    batchSelectedTables.delete(tableName);
                }
            });
            updateBatchActionBar();
        });

        // 批量操作栏关闭
        batchClose.addEventListener('click', function() {
            batchSelectedTables.clear();
            selectedTableBody.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.classList.remove('checked');
            });
            selectAllCheckbox.classList.remove('checked');
            updateBatchActionBar();
        });

        // 批量操作 - 仅示例提示
        batchSyncStart.addEventListener('click', function() {
            if (this.classList.contains('disabled')) return;
            alert('功能演示：批量设置首次同步起点');
        });

        batchSubTable.addEventListener('click', function() {
            if (this.classList.contains('disabled')) return;
            alert('功能演示：批量设置子表处理方式');
        });

        // 批量删除
        batchDelete.addEventListener('click', function() {
            if (batchSelectedTables.size === 0) return;
            
            if (confirm(`确定要删除选中的 ${batchSelectedTables.size} 张表吗？`)) {
                batchSelectedTables.forEach(tableName => {
                    delete selectedTables[tableName];
                    // 取消左侧勾选
                    document.querySelectorAll('.tree-item').forEach(item => {
                        if (item.dataset.table === tableName) {
                            item.querySelector('.tree-checkbox').classList.remove('checked');
                        }
                    });
                });
                batchSelectedTables.clear();
                updateSelectedTableDisplay();
            }
        });

        // 搜索功能
        const tableSearch = document.getElementById('tableSearch');
        tableSearch.addEventListener('input', function() {
            const searchText = this.value.toLowerCase().trim();
            
            // 搜索左侧的表列表
            document.querySelectorAll('.tree-item').forEach(item => {
                const tableName = item.dataset.table.toLowerCase();
                if (searchText === '' || tableName.includes(searchText)) {
                    item.style.display = 'flex';
                    // 匹配时展开父分类
                    let category = item.closest('.tree-category');
                    if (category) {
                        category.classList.add('expanded');
                        category.querySelector('.tree-category-icon').classList.remove('fa-caret-right');
                        category.querySelector('.tree-category-icon').classList.add('fa-caret-down');
                    }
                } else {
                    item.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>